name: Ledger Diff Check

on:
  pull_request:
    paths:
      - "tokenledger/**"
  push:
    branches:
      - main
    paths:
      - "tokenledger/**"

jobs:
  ledger-diff-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tokenledger
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Refresh deterministic ledger artifacts
        run: |
          python3 ./scripts/refresh_ledger.py --allow-missing-snapshot --skip-runtime-discovery

      - name: Ensure generated artifacts are committed
        run: |
          git diff --exit-code -- ./ledger/unified_model_provider_ledger.csv ./ledger/unified_model_provider_ledger.schema.sql ./ledger/unified_model_provider_ledger.seed.sql ./ledger/unified_model_provider_pareto.csv ./ledger/unified_model_provider_pareto.view.sql ./ledger/cliproxyapi_runtime_metrics_snapshot.csv
